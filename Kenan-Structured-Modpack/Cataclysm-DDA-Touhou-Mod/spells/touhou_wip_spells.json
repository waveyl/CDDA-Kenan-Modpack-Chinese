[
  {
    "id": "aa_notespell",
    "type": "SPELL",
    "name": "Note spell",
    "description": "These spells don't work, there's a critical component missing, they just don't work at all, or their implementation isn't the best",
    "spell_class": "NONE",
    "valid_targets": [ "none" ],
    "effect": "attack",
    "shape": "blast",
    "min_damage": 1,
    "max_damage": 1,
    "max_level": 1,
    "difficulty": -11,
    "base_casting_time": 100,
    "base_energy_cost": 100,
    "energy_source": "MANA"
  },
  {
    "id": "iku_batteryrestore1",
    "type": "SPELL",
    "name": "Restore battery (ultra light)",
    "description": "Use a small amount of electric power to restore ultra light batteries.",
    "spell_class": "NONE",
    "valid_targets": [ "none" ],
    "components": "spell_components_battery_ultralight",
    "effect": "spawn_item",
    "effect_str": "light_minus_battery_cell",
    "shape": "blast",
    "min_duration": 100,
    "max_duration": 100,
    "max_level": 1,
    "difficulty": -11,
    "base_casting_time": 1000,
    "base_energy_cost": 50,
    "energy_source": "MANA",
    "flags": [ "CONCENTRATE", "NO_LEGS", "PERMANENT" ],
    "//": "These spells don't work because batteries are spawned with zero energy, instead of full"
  },
  {
    "id": "iku_batteryrestore2",
    "type": "SPELL",
    "name": "Restore battery (light)",
    "description": "Use a small amount of electric power to restore light batteries.",
    "spell_class": "NONE",
    "valid_targets": [ "none" ],
    "components": "spell_components_battery_light",
    "effect": "spawn_item",
    "effect_str": "light_battery_cell",
    "shape": "blast",
    "min_duration": 100,
    "max_duration": 100,
    "max_level": 1,
    "difficulty": -11,
    "base_casting_time": 1000,
    "base_energy_cost": 75,
    "energy_source": "MANA",
    "flags": [ "CONCENTRATE", "NO_LEGS", "PERMANENT" ]
  },
  {
    "id": "iku_batteryrestore3",
    "type": "SPELL",
    "name": "Restore battery (medium)",
    "description": "Use a small amount of electric power to restore medium batteries.",
    "spell_class": "NONE",
    "valid_targets": [ "none" ],
    "components": "spell_components_battery_medium",
    "effect": "spawn_item",
    "effect_str": "medium_battery_cell",
    "shape": "blast",
    "min_duration": 100,
    "max_duration": 100,
    "max_level": 1,
    "difficulty": -11,
    "base_casting_time": 1000,
    "base_energy_cost": 100,
    "energy_source": "MANA",
    "flags": [ "CONCENTRATE", "NO_LEGS", "PERMANENT" ]
  },
  {
    "id": "iku_batteryrestore4",
    "type": "SPELL",
    "name": "Restore battery (heavy)",
    "description": "Use your electric power to restore heavy batteries.",
    "spell_class": "NONE",
    "valid_targets": [ "none" ],
    "components": "spell_components_battery_heavy",
    "effect": "spawn_item",
    "effect_str": "heavy_battery_cell",
    "shape": "blast",
    "min_duration": 100,
    "max_duration": 100,
    "max_level": 1,
    "difficulty": -11,
    "base_casting_time": 1000,
    "base_energy_cost": 125,
    "energy_source": "MANA",
    "flags": [ "CONCENTRATE", "NO_LEGS", "PERMANENT" ]
  },
  {
    "id": "iku_palm",
    "type": "SPELL",
    "name": "Double palm discharge (damage)",
    "description": "Damage component for tec_iku_palm ",
    "spell_class": "NONE",
    "valid_targets": [ "ground", "hostile" ],
    "effect": "attack",
    "shape": "line",
    "damage_type": "electric",
    "min_damage": { "math": [ "( (u_skill('dodge') * 1.5 ) + (u_skill('unarmed') * 1.5 ) + 9 )" ] },
    "max_damage": 45,
    "min_range": 3,
    "max_range": 3,
    "field_id": "fd_electricity",
    "field_chance": 2,
    "min_field_intensity": 1,
    "max_field_intensity": 1,
    "max_level": 1,
    "difficulty": -11,
    "base_casting_time": 0,
    "base_energy_cost": 0,
    "energy_source": "MANA",
    "flags": [ "NO_LEGS", "SOMATIC" ],
    "//": "Modified iku_thunderfish_base as this is procced automatically by MA techniques",
    "//2": "min dmg 15",
    "//3": "This is working properly when using as MA technique 'eocs', but it's not implemented as I think it's too clunky to have two directional spells proccing from techniques"
  },
  {
    "id": "kaenbyou_vspossess",
    "type": "SPELL",
    "name": { "str": "Possession: Vengeful spirit" },
    "description": "Command the targeted vengeful spirit to possess a nearby zombie.",
    "spell_class": "NONE",
    "valid_targets": [ "ally" ],
    "targeted_monster_ids": [ "mon_vengeful_spirit" ],
    "effect": "effect_on_condition",
    "effect_str": "kaenbyou_vspossess_eoc",
    "shape": "blast",
    "min_range": 4,
    "max_range": 4,
    "max_level": 1,
    "difficulty": -11,
    "base_casting_time": 66,
    "base_energy_cost": 66,
    "energy_source": "MANA",
    "flags": [ "NO_LEGS", "VERBAL" ]
  },
  {
    "id": "vs_possess_tag_spell",
    "type": "SPELL",
    "name": { "str": "Possession: Vengeful spirit (spell tag)" },
    "description": "This is casted by mon_vengeful_spirit and forces those under the aoe to run the EOC, which adds var_ for each enemy under the aoe",
    "spell_class": "NONE",
    "valid_targets": [ "ally", "hostile", "self" ],
    "effect": "effect_on_condition",
    "effect_str": "vs_possess_tag_eoc",
    "shape": "blast",
    "min_aoe": 20,
    "max_aoe": 20,
    "max_level": 1,
    "difficulty": -11,
    "base_casting_time": 0,
    "base_energy_cost": 0,
    "energy_source": "MANA",
    "flags": [ "NO_FAIL", "NO_HANDS", "NO_LEGS", "SILENT" ]
  },
  {
    "id": "vs_possess_possessed",
    "type": "SPELL",
    "name": { "str": "Possession: Vengeful spirit (summoning mon_vengeful_posessed )" },
    "description": " ",
    "spell_class": "NONE",
    "valid_targets": [ "ally", "hostile", "self" ],
    "effect": "attack",
    "shape": "blast",
    "damage_type": "pure",
    "min_damage": 999,
    "max_damage": 999,
    "min_aoe": 16,
    "max_aoe": 16,
    "max_level": 1,
    "difficulty": -11,
    "base_casting_time": 0,
    "base_energy_cost": 0,
    "energy_source": "MANA",
    "flags": [ "NO_EXPLOSION_SFX", "NO_FAIL", "NO_HANDS", "NO_LEGS", "SILENT" ]
  },
  {
    "id": "vs_possess_chasm",
    "type": "SPELL",
    "name": { "str": "Possession: Vengeful spirit (summoning mon_vengeful_chasm )" },
    "description": " ",
    "spell_class": "NONE",
    "valid_targets": [ "ally", "hostile", "self" ],
    "effect": "attack",
    "shape": "blast",
    "damage_type": "pure",
    "min_damage": 999,
    "max_damage": 999,
    "min_aoe": 16,
    "max_aoe": 16,
    "max_level": 1,
    "difficulty": -11,
    "base_casting_time": 0,
    "base_energy_cost": 0,
    "energy_source": "MANA",
    "flags": [ "NO_EXPLOSION_SFX", "NO_FAIL", "NO_HANDS", "NO_LEGS", "SILENT" ]
  },
  {
    "id": "kaenbyou_vspossess_eoc",
    "type": "effect_on_condition",
    "effect": [
      { "math": [ "u_var_vspossess_selected", "+=", "1" ] },
      { "u_cast_spell": { "id": "vs_possess_tag_spell" }, "targeted": false }
    ],
    "//": "_selected identifies that specific mon_vengeful_spirit as the 'source' of everything else downstream",
    "//2": "The chain below is broken btw, I was testing for the vs to cast the 999 pure dmg spells in aoe above, but they don't do it"
  },
  {
    "id": "vs_possess_tag_eoc",
    "type": "effect_on_condition",
    "effect": [
      { "math": [ "var_vspossess_counter_vs", "+=", "1" ] },
      {
        "run_eocs": [
          {
            "id": "vs_possess_tag_1",
            "condition": { "math": [ "u_monsters_nearby('mon_zombie', 'radius': 3)", ">", "0" ] },
            "effect": [
              { "math": [ "var_vspossess_counter_zombie", "+=", "1" ] }
            ]
          },
          {
            "id": "vs_possess_tag_2",
            "condition": { "math": [ "u_monsters_nearby('mon_vengeful_spirit', 'radius': 3)", ">", "0" ] },
            "effect": [
              { "math": [ "var_vspossess_counter_vs", "+=", "1" ] }
            ]
          },
          {
            "id": "vs_possess_tag_3",
            "condition": {
              "and": [
                { "math": [ "u_var_vspossess_selected", ">=", "1" ] },
                { "math": [ "var_vspossess_counter_zombie", ">=", "1" ] },
                { "math": [ "var_vspossess_counter_vs", "==", "1" ] }
              ]
            },
            "effect": [
              { "math": [ "var_vspossess_counter_zombie", "=", "0" ] },
              { "math": [ "var_vspossess_counter_vs", "=", "0" ] },
              { "u_cast_spell": { "id": "vs_possess_possessed" }, "targeted": false }
            ]
          },
          {
            "id": "vs_possess_tag_4",
            "condition": {
              "and": [
                { "math": [ "u_var_vspossess_selected", ">=", "1" ] },
                { "math": [ "var_vspossess_counter_zombie", ">=", "1" ] },
                { "math": [ "var_vspossess_counter_vs", ">=", "1" ] }
              ]
            },
            "effect": [
              { "math": [ "var_vspossess_counter_zombie", "=", "0" ] },
              { "math": [ "var_vspossess_counter_vs", "=", "0" ] },
              { "u_cast_spell": { "id": "vs_possess_chasm" }, "targeted": false }
            ]
          },
          {
            "id": "vs_possess_tag_5",
            "effect": [
              { "queue_eocs": [ "vs_possess_end" ], "time_in_future": "2 s" }
            ]
          }
        ]
      }
    ]
  },
  {
    "id": "vs_possess_possessed_eoc",
    "type": "effect_on_condition",
    "effect": [
      {
        "run_eocs": [
          {
            "id": "vs_possess_possessed_1",
            "condition": {
              "or": [
                { "math": [ "u_var_vspossess_zombie", ">=", "1" ] },
                {
                  "and": [
                    { "math": [ "u_var_vspossess_vs", ">=", "1" ] },
                    { "math": [ "u_var_vspossess_selected", "==", "0" ] }
                  ]
                }
              ]
            },
            "effect": [ "u_die" ]
          },
          {
            "id": "vs_possess_possessed_2",
            "condition": { "math": [ "u_var_vspossess_selected", ">=", "1" ] },
            "effect": [ { "u_spawn_monster": "mon_vengeful_posessed", "real_count": 1, "min_radius": 1, "max_radius": 2 } ]
          },
          {
            "id": "vs_possess_possessed_3",
            "effect": [ "u_die" ]
          }
        ]
      }
    ]
  },
  {
    "id": "vs_possess_end",
    "type": "effect_on_condition",
    "effect": [
      { "math": [ "var_vspossess_counter_zombie", "=", "0" ] },
      { "math": [ "var_vspossess_counter_vs", "=", "0" ] }
    ]
  },
  {
    "id": "nitori_mortar",
    "type": "SPELL",
    "name": { "str": "Mortar (TEST)" },
    "description": "Test for a mortar-type spell",
    "spell_class": "NONE",
    "valid_targets": [ "self" ],
    "effect": "effect_on_condition",
    "effect_str": "nitori_mortar_eoc",
    "shape": "blast",
    "max_level": 1,
    "difficulty": -11,
    "base_casting_time": 0,
    "base_energy_cost": 0,
    "energy_source": "MANA",
    "flags": [ "NO_HANDS", "NO_LEGS", "SOMATIC" ],
    "//": "This spell doesn't work: The 'loc' below from the u_cast_spell seems to be inactive regardless of the hit_self and targeted combinations: it is always centered on Nitori"
  },
  {
    "id": "nitori_mortarBLAST",
    "type": "SPELL",
    "name": { "str": "Mortar (TEST) (BLAST)" },
    "description": "The BLAST of nitori_mortar ",
    "spell_class": "NONE",
    "valid_targets": [ "ally", "field", "ground", "hostile", "item", "self" ],
    "effect": "attack",
    "shape": "blast",
    "damage_type": "bash",
    "min_damage": 20,
    "max_damage": 20,
    "min_range": 99,
    "max_range": 99,
    "min_aoe": 6,
    "max_aoe": 6,
    "max_level": 1,
    "difficulty": -11,
    "base_casting_time": 0,
    "base_energy_cost": 0,
    "energy_source": "MANA",
    "flags": [ "NO_HANDS", "NO_LEGS", "SOMATIC" ]
  },
  {
    "id": "nitori_mortar_eoc",
    "type": "effect_on_condition",
    "effect": [
      {
        "if": {
          "message": "Select target", 
          "range": 10,
          "u_query_tile": "anywhere",
          "target_var": { "context_val": "var_nitori_mortar_loc" }
        },
        "then": { "queue_eocs": [ "nitori_mortar_BLAST" ], "time_in_future": "1 s" },
        "else": { "u_message": "Canceled" }
      }
    ]
  },
  {
    "id": "nitori_mortar_BLAST",
    "type": "effect_on_condition",
    "effect": [
      { "u_cast_spell": { "id": "nitori_mortarBLAST" }, "loc": { "global_val": "var_nitori_mortar_loc" } }
    ]
  },
  {
    "id": "sakuya_knifepull",
    "type": "SPELL",
    "name": { "str": "Knife retrieval" },
    "description": "Stop time to retrieve nearby knives (without anyone noticing it).",
    "valid_targets": [ "self", "item" ],
    "effect": "area_pull",
    "effect_str": "KNIVES",
    "extra_effects": [ { "id": "sakuya_knifepull2" } ],
    "shape": "blast",
    "min_damage": 50,
    "max_damage": 50,
    "min_aoe": 6,
    "max_aoe": 26,
    "aoe_increment": 2,
    "max_level": 1,
    "difficulty": -11,
    "message": "You elegantly retrieve nearby knives.",
    "base_casting_time": 0,
    "base_energy_cost": 0,
    "energy_source": "MANA",
    "flags": [ "NO_HANDS", "NO_PROJECTILE", "SILENT", "WONDER" ],
    "//": "This is deactivated: there's currently no way to pull *only* knives, any 'item' in the aoe is pulled, which is not good. Also, the WONDER + x50 spell repeats as area_pull seems hardcoded to 1 tile per action, which works good enough for this spell specially but it's something to keep in mind"
  },
  {
    "id": "sakuya_knifepull2",
    "type": "SPELL",
    "name": { "str": "Knife retrieval" },
    "description": "Stop time to retrieve nearby knives (without anyone noticing it).",
    "valid_targets": [ "self", "item" ],
    "effect": "area_pull",
    "effect_str": "KNIVES",
    "shape": "blast",
    "min_damage": 50,
    "max_damage": 50,
    "min_aoe": 6,
    "max_aoe": 26,
    "aoe_increment": 2,
    "max_level": 1,
    "difficulty": -11,
    "message": "",
    "base_casting_time": 0,
    "base_energy_cost": 0,
    "energy_source": "MANA",
    "flags": [ "NO_HANDS", "NO_PROJECTILE", "SILENT" ]
  },
  {
    "id": "yamame_damnedrope_UPDATED",
    "type": "SPELL",
    "name": "Damned's rope",
    "description": "Entangle a target and pull it towards your position, stunning it for a short time.",
    "spell_class": "NONE",
    "valid_targets": [ "self" ],
    "effect": "effect_on_condition",
    "effect_str": "yamame_damnedrope_eoc_UPDATED",
    "shape": "blast",
    "max_level": 1,
    "difficulty": -11,
    "base_casting_time": 66,
    "base_energy_cost": 100,
    "energy_source": "MANA",
    "flags": [ "NO_EXPLOSION_SFX", "NO_HANDS", "NO_PROJECTILE", "SILENT" ],
    "//": "Updated version of yamame_damnedrope. Adapted from dash_kokoro. The old 'pull (+ damnedrope_strength_effect)' spell doesn't work, the STR buff is granted after the spell casts, so the pull fails due using the base STR. This 'spell_EOC -> EOC -> effect, mutation, pull -> EOC' version works, with a caveat",
    "//2": "The pull works (it behaves with the STR bonus) if and only if yamame_damnedrope_eoc_UPDATED grants both the effect and mutation simultaneously. Removing any causes the pull to use base STR (and thus not work)",
    "//3": "The problem with leaving it like this is that Yamame is granted the total STR from both sources (152) for 2 - 3 turns after the spell is cast",
    "//4": "An alternative version of the spell uses the description 'Gather your strength to entangle and pull a target' so the STR buff can ramp up before casting the pull, and lasts for less"
  },
  {
    "id": "yamame_damnedrope2_UPDATED",
    "type": "SPELL",
    "name": "Damned's rope (pull)",
    "description": "Entangle a target and pull it towards your position, stunning it for a short time.",
    "spell_class": "NONE",
    "valid_targets": [ "ally", "hostile" ],
    "effect": "pull_target",
    "extra_effects": [ { "id": "yamame_damnedrope3_UPDATED" } ],
    "shape": "line",
    "min_range": { "math": [ "( (u_skill('speech') * 0.7 ) + (u_skill('dodge') * 0.7 ) + 4.1 )" ] },
    "max_range": 23,
    "field_id": "fd_web2",
    "field_chance": 1,
    "min_field_intensity": 2,
    "max_field_intensity": 3,
    "max_level": 1,
    "difficulty": -11,
    "base_casting_time": 0,
    "base_energy_cost": 0,
    "energy_source": "MANA",
    "flags": [ "EXTRA_EFFECTS_FIRST", "NO_LEGS", "SOMATIC" ],
    "//": "min range 9"
  },
  {
    "id": "yamame_damnedrope3_UPDATED",
    "type": "SPELL",
    "name": "Damned's rope (stun)",
    "description": "Stun component of yamame_damnedrope ",
    "spell_class": "NONE",
    "valid_targets": [ "ally", "hostile" ],
    "effect": "mod_moves",
    "shape": "blast",
    "damage_type": "pure",
    "min_damage": -300,
    "max_damage": -600,
    "max_level": 1,
    "difficulty": -11,
    "base_casting_time": 0,
    "base_energy_cost": 0,
    "energy_source": "MANA",
    "flags": [ "NO_HANDS", "NO_LEGS", "RANDOM_DAMAGE", "SILENT" ]
  },
  {
    "id": "yamame_damnedrope_eoc_UPDATED",
    "type": "effect_on_condition",
    "effect": [ 
      { "u_message": "yamame_damnedrope_eoc_1", "type": "mixed" },
      { "u_add_effect": "damnedrope_strength_effect", "duration": "1 s" },
      { "u_add_trait": "damnedrope_strength_mut" },
      { "u_cast_spell": { "id": "yamame_damnedrope2_UPDATED" }, "targeted": true },
      { "queue_eocs": [ "yamame_damnedrope_end_UPDATED" ], "time_in_future": "1 s" }
    ]
  },
  {
    "id": "yamame_damnedrope_end_UPDATED",
    "type": "effect_on_condition",
    "effect": [ 
      { "u_message": "yamame_damnedrope_eoc_2", "type": "mixed" },
      { "u_lose_effect": "damnedrope_strength_effect" },
      { "u_lose_trait": "damnedrope_strength_mut" }
    ]
  }
]
